<!DOCTYPE html>
<html>
<head>
    <title>Pytvzhen Downloader</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css') }}">
    <script src="{{ url_for('static', filename='jquery-3.5.1.min.js') }}"></script>
    <script src="{{ url_for('static', filename='popper.min.js') }}"></script>
    <script src="{{ url_for('static', filename='bootstrap.min.js') }}"></script>
</head>
<body>

<div style="text-align: center">
    <img src="{{ url_for('static', filename='cartography.png') }}">
</div>

<div style="text-align: center; background-color: yellow; color: black; padding: 10px;">
    这只是一个用于测试后端的简易界面
</div>

<div class="container">

    <!-- Modal -->
    <div class="modal fade" id="responseModal" tabindex="-1" role="dialog" aria-labelledby="responseModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="responseModalLabel">Server Response</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="serverResponse">
                    <!-- Server response will be inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


    <h1 class="text-center my-4">使用ID下载Youtube视频或上传视频</h1>
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">使用ID下载Youtube视频</h5>

                    <form action="/yt_download" method="post" id="downloadForm">
                        <label for="video_id">Enter YouTube Video ID:</label><br>
                        <input type="text" id="video_id" name="video_id"><br>
                        <input type="submit" value="Download">
                        <a id="downloadButton" class="btn btn-primary" role="button" style="display: none;">Download
                            Video</a>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">上传你的视频</h5>
                    <form action="/video_upload" method="post" enctype="multipart/form-data" id="uploadForm">
                        <div class="form-group">
                            <input type="file" class="form-control-file" name="file" accept=".mp4">
                        </div>

                        <button type="submit" class="btn btn-primary">Upload</button>
                    </form>
                    <div class="progress mt-3">
                        <div id="uploadProgressBar" class="progress-bar" role="progressbar" style="width: 0%;"
                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h1 class="text-center my-4">提取Youtube音频</h1>
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form action="/extra_audio/" method="post" id="extractAudioForm">
                        <label for="video_id">Enter YouTube Video ID to extract Audio:</label><br>
                        <input type="text" id="video_id" name="video_id"><br>
                        <input type="submit" value="ExtractAudio">
                        <a id="extractAudioButton" class="btn btn-primary" role="button" style="display: none;">Extract
                            Audio</a>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <h1 class="text-center my-4">去除Youtube音频背景音乐</h1>
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form action="/remove_audio_bg/" method="post" id="removeBackgroundMusicForm">
                        <label for="video_id">Enter YouTube Video ID to extract Audio:</label><br>
                        <input type="text" id="video_id" name="video_id"><br>
                        <input type="submit" value="Extract Voice and Background Music">
                        <a id="downloadVoiceButton" class="btn btn-primary" role="button" style="display: none;">Download
                            Voice</a>
                        <a id="downloadBackgroundButton" class="btn btn-primary" role="button" style="display: none;">Download
                            Background</a>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <h1 class="text-center my-4">从英文音频中提取原始源字幕</h1>
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form action="/transcribe/" method="post" id="transcribeEnForm">
                        <label for="video_id">Enter YouTube Video ID to transcribe:</label><br>
                        <input type="text" id="video_id" name="video_id"><br>
                        <input type="submit" value="Transcribe SRT from English">
                        <a id="downloadSrtEnMergedButton" class="btn btn-primary" role="button" style="display: none;">Download
                            SRT Merged</a>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <h1 class="text-center my-4">生成配音字幕</h1>
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">翻译英文以生成配音字幕</h5>
                    <form action="/translate_to_zh/" method="post" id="translateToZh">
                        <label for="video_id">Enter YouTube Video ID to transcribe:</label><br>
                        <input type="text" id="video_id" name="video_id"><br>
                        <label for="source_lang">Enter Translation source language:</label><br>
                        <input type="text" id="source_lang" name="source_lang"><br>
                        <label for="translate_vendor">Translation vendor:</label><br>
                        <select id="translate_vendor" name="translate_vendor">
                            <option value="google">Google Translate (免费)</option>
                            <option value="deepl">DeepL (需要API密钥)</option>
                            <option value="gpt-3.5-turbo-0125">ChatGPT 3.5 Turbo (需要OpenAI API密钥)</option>
                            <option value="gpt-4">ChatGPT 4 (需要OpenAI API密钥)</option>
                            <option value="gpt-4-turbo">ChatGPT 4 Turbo (需要OpenAI API密钥)</option>
                            <option value="gpt-local">本地部署 (自定义URL和模型)</option>
                        </select><br>
                        
                        <!-- 本地部署配置 -->
                        <div id="local_deployment_config" style="display: none;">
                            <label for="base_url">API基础URL:</label><br>
                            <input type="text" id="base_url" name="base_url" placeholder="http://localhost:11434/v1/"><br>
                            <label for="model_name">模型名称:</label><br>
                            <input type="text" id="model_name" name="model_name" placeholder="qwen2.5:7b"><br>
                        </div>
                        
                        <label for="translate_key">Translation API Key (DeepL/ChatGPT需要):</label><br>
                        <input type="text" id="translate_key" name="translate_key" placeholder="输入API密钥"><br>
                        <input type="submit" value="Translate to Chinese">
                        <a id="downloadSrtZhMergeButton" class="btn btn-primary" role="button" style="display: none;">Download
                            zh SRT</a>
                    </form>
                </div>
            </div>
        </div>

                
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">上传修改后的配音字幕</h5>
                    <form action="/translated_zh_upload" method="post" enctype="multipart/form-data" id="uploadZhMerge">
                        <label for="video_id">Enter Video ID to transcribe:</label><br>
                        <input type="text" id="video_id" name="video_id"><br>
                        <div class="form-group">
                            <input type="file" class="form-control-file" name="file" accept=".srt">
                        </div>
                        <button type="submit" class="btn btn-primary">Upload</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <h1 class="text-center my-4">中文字幕配音</h1>
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form action="/tts/" method="post" id="tts">
                        <label for="video_id">Enter YouTube Video ID to transcribe:</label><br>
                        <input type="text" id="video_id" name="video_id"><br>
                        
                        <label for="tts_vendor">TTS 供应商:</label><br>
                        <select id="tts_vendor" name="tts_vendor">
                            <option value="edge">Edge TTS (微软)</option>
                            <option value="xtts_v2">XTTS v2 (Coqui TTS)</option>
                        </select><br>
                        
                        <!-- Edge TTS 配置 -->
                        <div id="edge_tts_config" class="tts-config">
                            <label for="tts_character">Edge TTS 角色:</label><br>
                            <input type="text" id="tts_character" name="tts_character" value="zh-CN-XiaoyiNeural"><br>
                        </div>
                        
                        <!-- XTTS v2 配置 -->
                        <div id="xtts_v2_config" class="tts-config" style="display: none;">
                            <label for="reference_audio">参考音频文件 (用于语音克隆):</label><br>
                            <input type="file" id="reference_audio" name="reference_audio" accept="audio/*"><br>
                            <button type="button" id="upload_reference_btn" class="btn btn-secondary">上传参考音频</button><br>
                            <span id="reference_audio_status"></span><br>
                            
                            <label for="language">目标语言:</label><br>
                            <select id="language" name="language">
                                <option value="zh">中文</option>
                                <option value="en">英文</option>
                                <option value="ja">日文</option>
                                <option value="ko">韩文</option>
                                <option value="es">西班牙文</option>
                                <option value="fr">法文</option>
                                <option value="de">德文</option>
                                <option value="it">意大利文</option>
                                <option value="pt">葡萄牙文</option>
                                <option value="ru">俄文</option>
                            </select><br>
                            
                            <label for="model_name">模型名称:</label><br>
                            <input type="text" id="model_name" name="model_name" value="tts_models/multilingual/multi-dataset/xtts_v2"><br>
                        </div>
                        
                        <input type="submit" value="Generate TTS">
                        <a id="downloadTTSButton" class="btn btn-primary" role="button" style="display: none;">Download
                            TTS</a>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <h1 class="text-center my-4">语音连接</h1>
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form action="/voice_connect/" method="post" id="voiceConnect">
                        <label for="video_id">Enter YouTube Video ID to transcribe:</label><br>
                        <input type="text" id="video_id" name="video_id"><br>
                        <input type="submit" value="Voice connect">
                        <a id="downloadvoiceConnectButton" class="btn btn-primary" role="button" style="display: none;">Download
                            Connected
                            Voice</a>
                        <a id="downloadvoiceConnectLogButton" class="btn btn-primary" role="button"
                           style="display: none;">Download
                            Connected
                            Voice log</a>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <h1 class="text-center my-4">渲染预览视频</h1>
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form action="/video_preview/" method="post" id="videoPreview">
                        <label for="video_id">Enter YouTube Video ID to transcribe:</label><br>
                        <input type="text" id="video_id" name="video_id"><br>
                        <input type="submit" value="video preview">
                        <a id="downloadViewoPreviewButton" class="btn btn-primary" role="button" style="display: none;">Download
                            Preview
                            Video</a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        $("#downloadForm").submit(function (e) {
            e.preventDefault();
            $.ajax({
                url: '/yt_download',
                type: 'post',
                contentType: 'application/json',
                data: JSON.stringify({"video_id": $("#downloadForm input[id=video_id]").val()}),
                success: function (response) {
                    $("#serverResponse").text(response.message);
                    $("#responseModal").modal('show');
                    $("#downloadButton").attr('href', '/yt/' + response.video_id);
                    $("#downloadButton").show();
                },
                error: function (response) {
                    $("#downloadButton").hide();
                    $("#serverResponse").text(response.responseJSON.message);
                    $("#responseModal").modal('show');
                }
            });
        });

        $("#uploadForm").submit(function (e) {
            e.preventDefault();
            $.ajax({
                url: '/video_upload',
                type: 'post',
                data: new FormData(this),
                contentType: false,
                processData: false,
                xhr: function () {
                    var xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener('progress', function (evt) {
                        if (evt.lengthComputable) {
                            var percentComplete = evt.loaded / evt.total;
                            percentComplete = parseInt(percentComplete * 100);
                            $('#uploadProgressBar').css('width', percentComplete + '%').attr('aria-valuenow', percentComplete).text(percentComplete + '%');
                        }
                    }, false);
                    return xhr;
                },
                success: function (response) {
                    $("#serverResponse").text(response.message);
                    $("#responseModal").modal('show');
                },
                error: function (response) {
                    $("#serverResponse").text(response.responseJSON.message);
                    $("#responseModal").modal('show');
                }
            });
        });

        $("#uploadZhMerge").submit(function (e) {
            e.preventDefault();

            var formData = new FormData(this);
            var videoID = $("#video_id").val(); // 假设视频 ID 存储在 id 为 videoID 的输入框中

            formData.append('video_id', videoID);

            $.ajax({
                url: '/translated_zh_upload',
                type: 'post',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    $("#serverResponse").text(response.message);
                    $("#responseModal").modal('show');
                },
                error: function (response) {
                    $("#serverResponse").text(response.responseJSON.message);
                    $("#responseModal").modal('show');
                }
            });
        });


        $("#extractAudioForm").submit(function (e) {
            e.preventDefault();
            $.ajax({
                url: '/extra_audio',
                type: 'post',
                contentType: 'application/json',
                data: JSON.stringify({"video_id": $("#extractAudioForm input[id=video_id]").val()}),
                success: function (response) {
                    $("#extractAudioButton").attr('href', '/audio/' + response.video_id);
                    $("#extractAudioButton").show();
                    $("#serverResponse").text(response.message);
                    $("#responseModal").modal('show');
                },
                error: function (response) {
                    $("#extractAudioButton").hide();
                    $("#serverResponse").text(response.responseJSON.message);
                    $("#responseModal").modal('show');
                }
            });
        });

        // TTS 供应商切换处理
        $("#tts_vendor").change(function() {
            var vendor = $(this).val();
            $(".tts-config").hide();
            if (vendor === "edge") {
                $("#edge_tts_config").show();
            } else if (vendor === "xtts_v2") {
                $("#xtts_v2_config").show();
            }
        });

        // 参考音频上传处理
        $("#upload_reference_btn").click(function() {
            var fileInput = $("#reference_audio")[0];
            if (!fileInput.files || fileInput.files.length === 0) {
                alert("请选择音频文件");
                return;
            }

            var formData = new FormData();
            formData.append('file', fileInput.files[0]);

            $.ajax({
                url: '/upload_reference_audio',
                type: 'post',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    $("#reference_audio_status").text("上传成功: " + response.filename).css("color", "green");
                    // 将文件路径存储到隐藏字段中
                    $("<input>").attr({
                        type: "hidden",
                        name: "reference_audio_path",
                        value: response.file_path
                    }).appendTo("#tts");
                },
                error: function (response) {
                    $("#reference_audio_status").text("上传失败: " + response.responseJSON.message).css("color", "red");
                }
            });
        });

        $("#removeBackgroundMusicForm").submit(function (e) {
            e.preventDefault();
            $.ajax({
                url: '/remove_audio_bg',
                type: 'post',
                contentType: 'application/json',
                data: JSON.stringify({"video_id": $("#removeBackgroundMusicForm input[id=video_id]").val()}),
                success: function (response) {
                    $("#downloadVoiceButton").attr('href', '/audio_no_bg/' + response.video_id);
                    $("#downloadVoiceButton").show();

                    $("#downloadBackgroundButton").attr('href', '/audio_bg/' + response.video_id);
                    $("#downloadBackgroundButton").show();

                    $("#serverResponse").text(response.message);
                    $("#responseModal").modal('show');
                },
                error: function (response) {
                    $("#downloadBackgroundButton").hide();
                    $("#serverResponse").text(response.responseJSON.message);
                    $("#responseModal").modal('show');
                }
            });
        });


        $("#transcribeEnForm").submit(function (e) {
            e.preventDefault();
            $.ajax({
                url: '/transcribe',
                type: 'post',
                contentType: 'application/json',
                data: JSON.stringify({"video_id": $("#transcribeEnForm input[id=video_id]").val()}),
                success: function (response) {
                    $("#downloadSrtEnMergedButton").attr('href', '/srt_en_merged/' + response.video_id);
                    $("#downloadSrtEnMergedButton").show();


                    $("#serverResponse").text(response.message);
                    $("#responseModal").modal('show');
                },
                error: function (response) {
                    $("#downloadSrtEnMergedButton").hide();
                    $("#serverResponse").text(response.responseJSON.message);
                    $("#responseModal").modal('show');
                }
            });
        });

        // 翻译供应商选择逻辑
        $("#translate_vendor").change(function() {
            var vendor = $(this).val();
            var apiKeyField = $("#translate_key");
            var apiKeyLabel = apiKeyField.prev("label");
            var localConfig = $("#local_deployment_config");
            
            // 隐藏所有特殊配置
            localConfig.hide();
            
            if (vendor === "google") {
                apiKeyField.hide();
                apiKeyLabel.hide();
            } else if (vendor === "gpt-local") {
                // 本地部署配置
                apiKeyField.show();
                apiKeyLabel.show();
                apiKeyField.attr("placeholder", "输入API密钥 (可选)");
                localConfig.show();
            } else {
                apiKeyField.show();
                apiKeyLabel.show();
                if (vendor.includes("gpt")) {
                    apiKeyField.attr("placeholder", "输入OpenAI API密钥");
                } else if (vendor === "deepl") {
                    apiKeyField.attr("placeholder", "输入DeepL API密钥");
                }
            }
        });
        
        // 页面加载时触发一次
        $("#translate_vendor").trigger("change");

        $("#translateToZh").submit(function (e) {
            e.preventDefault();
            $.ajax({
                url: '/translate_to_zh',
                type: 'post',
                contentType: 'application/json',
                data: JSON.stringify({
                    "video_id": $("#translateToZh input[id=video_id]").val(),
                    "source_lang": $("#translateToZh input[id=source_lang]").val(),
                    "translate_vendor": $("#translateToZh select[id=translate_vendor]").val(),
                    "translate_key": $("#translateToZh input[id=translate_key]").val(),
                    "base_url": $("#translateToZh input[id=base_url]").val(),
                    "model_name": $("#translateToZh input[id=model_name]").val()
                }),
                success: function (response) {
                    $("#downloadSrtZhMergeButton").attr('href', '/srt_zh_merged/' + response.video_id);
                    $("#downloadSrtZhMergeButton").show();

                    $("#serverResponse").text(response.message);
                    $("#responseModal").modal('show');
                },
                error: function (response) {
                    $("#downloadSrtZhMergeButton").hide();
                    $("#serverResponse").text(response.responseJSON.message);
                    $("#responseModal").modal('show');
                }
            });
        });

        $("#tts").submit(function (e) {
            e.preventDefault();
            
            // 构建请求数据
            var requestData = {
                "video_id": $("#tts input[id=video_id]").val(),
                "tts_vendor": $("#tts select[id=tts_vendor]").val(),
                "tts_character": $("#tts input[id=tts_character]").val()
            };
            
            // 如果是 XTTS v2，添加额外参数
            if (requestData.tts_vendor === 'xtts_v2') {
                requestData.language = $("#tts select[id=language]").val();
                requestData.model_name = $("#tts input[id=model_name]").val();
                
                // 获取参考音频路径（从隐藏字段）
                var referenceAudioPath = $("#tts input[name=reference_audio_path]").val();
                if (referenceAudioPath) {
                    requestData.reference_audio_path = referenceAudioPath;
                }
            }
            
            $.ajax({
                url: '/tts',
                type: 'post',
                contentType: 'application/json',
                data: JSON.stringify(requestData),
                success: function (response) {
                    $("#downloadTTSButton").attr('href', '/tts/' + response.video_id);
                    $("#downloadTTSButton").show();

                    $("#serverResponse").text(response.message);
                    $("#responseModal").modal('show');
                },
                error: function (response) {
                    $("#downloadTTSButton").hide();
                    $("#serverResponse").text(response.responseJSON.message);
                    $("#responseModal").modal('show');
                }
            });
        });

        $("#voiceConnect").submit(function (e) {
            e.preventDefault();
            $.ajax({
                url: '/voice_connect',
                type: 'post',
                contentType: 'application/json',
                data: JSON.stringify({"video_id": $("#voiceConnect input[id=video_id]").val()}),
                success: function (response) {
                    $("#downloadvoiceConnectButton").attr('href', '/voice_connect/' + response.video_id);
                    $("#downloadvoiceConnectButton").show();
                    $("#downloadvoiceConnectLogButton").attr('href', '/voice_connect_log/' + response.video_id);
                    $("#downloadvoiceConnectLogButton").show();
                    $("#serverResponse").text(response.message);
                    $("#responseModal").modal('show');
                },
                error: function (response) {
                    $("#downloadvoiceConnectButton").hide();
                    $("#serverResponse").text(response.responseJSON.message);

                }
            });
        });

        $("#videoPreview").submit(function (e) {
            e.preventDefault();
            $.ajax({
                url: '/video_preview',
                type: 'post',
                contentType: 'application/json',
                data: JSON.stringify({"video_id": $("#videoPreview [id=video_id]").val()}),
                success: function (response) {
                    $("#downloadViewoPreviewButton").attr('href', '/video_preview/' + response.video_id);
                    $("#downloadViewoPreviewButton").show();
                    $("#serverResponse").text(response.message);
                    $("#responseModal").modal('show');
                },
                error: function (response) {
                    $("#downloadViewoPreviewButton").hide();
                    $("#serverResponse").text(response.responseJSON.message);
                    $("#responseModal").modal('show');
                }
            });
        });
    });
</script>
</body>
</html>