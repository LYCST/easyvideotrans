<!DOCTYPE html>
<html>
<head>
    <title>TTS 前端测试</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 5px; }
        .tts-config { margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 3px; }
        .btn { padding: 8px 16px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        select, input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; }
        .status { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>TTS 前端测试页面</h1>
        
        <div class="card">
            <h3>中文字幕配音</h3>
            <form id="tts">
                <label for="video_id">视频ID:</label><br>
                <input type="text" id="video_id" name="video_id" value="Am54LhN2NLk"><br>
                
                <label for="tts_vendor">TTS 供应商:</label><br>
                <select id="tts_vendor" name="tts_vendor">
                    <option value="edge">Edge TTS (微软)</option>
                    <option value="xtts_v2">XTTS v2 (Coqui TTS)</option>
                    <option value="cosyvoice2">CosyVoice2 (腾讯)</option>
                    <option value="fallback">Fallback TTS (备用)</option>
                </select><br>
                
                <!-- Edge TTS 配置 -->
                <div id="edge_tts_config" class="tts-config">
                    <label for="tts_character">Edge TTS 角色:</label><br>
                    <input type="text" id="tts_character" name="tts_character" value="zh-CN-XiaoyiNeural"><br>
                </div>
                
                <!-- XTTS v2 配置 -->
                <div id="xtts_v2_config" class="tts-config" style="display: none;">
                    <label for="reference_audio">参考音频文件:</label><br>
                    <input type="file" id="reference_audio" name="reference_audio" accept="audio/*"><br>
                    <button type="button" id="upload_reference_btn" class="btn btn-secondary">上传参考音频</button><br>
                    <span id="reference_audio_status"></span><br>
                    
                    <label for="language">目标语言:</label><br>
                    <select id="language" name="language">
                        <option value="zh">中文</option>
                        <option value="en">英文</option>
                        <option value="ja">日文</option>
                        <option value="ko">韩文</option>
                    </select><br>
                    
                    <label for="model_name">模型名称:</label><br>
                    <input type="text" id="model_name" name="model_name" value="tts_models/multilingual/multi-dataset/xtts_v2"><br>
                </div>
                
                <!-- CosyVoice2 配置 -->
                <div id="cosyvoice2_config" class="tts-config" style="display: none;">
                    <label for="cosyvoice2_reference_audio">参考音频文件:</label><br>
                    <input type="file" id="cosyvoice2_reference_audio" name="cosyvoice2_reference_audio" accept="audio/*"><br>
                    <button type="button" id="upload_cosyvoice2_reference_btn" class="btn btn-secondary">上传参考音频</button><br>
                    <span id="cosyvoice2_reference_audio_status"></span><br>
                    
                    <label for="cosyvoice2_speaker_name">说话人名称:</label><br>
                    <input type="text" id="cosyvoice2_speaker_name" name="cosyvoice2_speaker_name" value="希望你以后能够做的比我还好呦。"><br>
                    
                    <label for="cosyvoice2_mode">生成模式:</label><br>
                    <select id="cosyvoice2_mode" name="cosyvoice2_mode">
                        <option value="zero_shot">零样本模式 (语音克隆)</option>
                        <option value="cross_lingual">跨语种模式</option>
                        <option value="instruct">指令模式</option>
                    </select><br>
                    
                    <label for="cosyvoice2_instruction">指令:</label><br>
                    <input type="text" id="cosyvoice2_instruction" name="cosyvoice2_instruction" value="用四川话说这句话"><br>
                    
                    <label for="cosyvoice2_model_path">模型路径:</label><br>
                    <input type="text" id="cosyvoice2_model_path" name="cosyvoice2_model_path" value="pretrained_models/CosyVoice2-0.5B"><br>
                    
                    <label for="cosyvoice2_fp16">使用FP16精度:</label><br>
                    <input type="checkbox" id="cosyvoice2_fp16" name="cosyvoice2_fp16" value="true"><br>
                </div>
                
                <!-- Fallback TTS 配置 -->
                <div id="fallback_config" class="tts-config" style="display: none;">
                    <label for="fallback_character">Fallback TTS 角色:</label><br>
                    <input type="text" id="fallback_character" name="fallback_character" value="zh-CN-XiaoyiNeural"><br>
                    <small>注意: Fallback TTS 是备用方案，当其他TTS服务不可用时使用</small><br>
                </div>
                
                <button type="submit" class="btn btn-primary">生成 TTS</button>
                <a id="downloadTTSButton" class="btn btn-primary" role="button" style="display: none;">下载 TTS</a>
            </form>
            
            <div id="response" class="status" style="display: none;"></div>
        </div>
    </div>

    <script>
        // TTS 供应商切换处理
        $("#tts_vendor").change(function() {
            var vendor = $(this).val();
            $(".tts-config").hide();
            if (vendor === "edge") {
                $("#edge_tts_config").show();
            } else if (vendor === "xtts_v2") {
                $("#xtts_v2_config").show();
            } else if (vendor === "cosyvoice2") {
                $("#cosyvoice2_config").show();
            } else if (vendor === "fallback") {
                $("#fallback_config").show();
            }
        });

        // 参考音频上传处理 (XTTS v2)
        $("#upload_reference_btn").click(function() {
            var fileInput = $("#reference_audio")[0];
            if (!fileInput.files || fileInput.files.length === 0) {
                alert("请选择音频文件");
                return;
            }

            var formData = new FormData();
            formData.append('file', fileInput.files[0]);

            $.ajax({
                url: '/upload_reference_audio',
                type: 'post',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    $("#reference_audio_status").text("上传成功: " + response.filename).css("color", "green");
                    $("<input>").attr({
                        type: "hidden",
                        name: "reference_audio_path",
                        value: response.file_path
                    }).appendTo("#tts");
                },
                error: function (response) {
                    $("#reference_audio_status").text("上传失败: " + response.responseJSON.message).css("color", "red");
                }
            });
        });
        
        // CosyVoice2 参考音频上传处理
        $("#upload_cosyvoice2_reference_btn").click(function() {
            var fileInput = $("#cosyvoice2_reference_audio")[0];
            if (!fileInput.files || fileInput.files.length === 0) {
                alert("请选择音频文件");
                return;
            }

            var formData = new FormData();
            formData.append('file', fileInput.files[0]);

            $.ajax({
                url: '/upload_reference_audio',
                type: 'post',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    $("#cosyvoice2_reference_audio_status").text("上传成功: " + response.filename).css("color", "green");
                    $("<input>").attr({
                        type: "hidden",
                        name: "cosyvoice2_reference_audio_path",
                        value: response.file_path
                    }).appendTo("#tts");
                },
                error: function (response) {
                    $("#cosyvoice2_reference_audio_status").text("上传失败: " + response.responseJSON.message).css("color", "red");
                }
            });
        });

        // TTS 表单提交处理
        $("#tts").submit(function (e) {
            e.preventDefault();
            
            var requestData = {
                "video_id": $("#tts input[id=video_id]").val(),
                "tts_vendor": $("#tts select[id=tts_vendor]").val(),
                "tts_character": $("#tts input[id=tts_character]").val()
            };
            
            // 根据不同的TTS供应商添加参数
            if (requestData.tts_vendor === 'xtts_v2') {
                requestData.language = $("#tts select[id=language]").val();
                requestData.model_name = $("#tts input[id=model_name]").val();
                var referenceAudioPath = $("#tts input[name=reference_audio_path]").val();
                if (referenceAudioPath) {
                    requestData.reference_audio_path = referenceAudioPath;
                }
            } else if (requestData.tts_vendor === 'cosyvoice2') {
                requestData.speaker_name = $("#tts input[id=cosyvoice2_speaker_name]").val();
                requestData.mode = $("#tts select[id=cosyvoice2_mode]").val();
                requestData.instruction = $("#tts input[id=cosyvoice2_instruction]").val();
                requestData.model_path = $("#tts input[id=cosyvoice2_model_path]").val();
                requestData.fp16 = $("#tts input[id=cosyvoice2_fp16]").is(':checked');
                var referenceAudioPath = $("#tts input[name=cosyvoice2_reference_audio_path]").val();
                if (referenceAudioPath) {
                    requestData.reference_audio_path = referenceAudioPath;
                }
            } else if (requestData.tts_vendor === 'fallback') {
                requestData.tts_character = $("#tts input[id=fallback_character]").val();
            }
            
            console.log("发送请求数据:", requestData);
            
            $.ajax({
                url: '/tts',
                type: 'post',
                contentType: 'application/json',
                data: JSON.stringify(requestData),
                success: function (response) {
                    $("#downloadTTSButton").attr('href', '/tts/' + response.video_id);
                    $("#downloadTTSButton").show();
                    $("#response").text("成功: " + response.message).removeClass("error").addClass("success").show();
                },
                error: function (response) {
                    $("#downloadTTSButton").hide();
                    $("#response").text("错误: " + response.responseJSON.message).removeClass("success").addClass("error").show();
                }
            });
        });
    </script>
</body>
</html>
